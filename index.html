<!--
  Copyright (c) 2012 Artem Zubkov.

  Licensed under the Apache License, Version 2.0 (the "License"); you may not
  use this file except in compliance with the License. You may obtain a copy of
  the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
  License for the specific language governing permissions and limitations under
  the License.
-->
<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'/>
    <script type="text/javascript" src="d3.v2.js"></script>
    <!--script type="text/javascript" src="protovis.js"></script-->
    <script type="text/javascript" src="global.js"></script>
    <script type="text/javascript" src="conf.js"></script>
    <script type="text/javascript" src="storage.js"></script>
    <script type="text/javascript" src="oauth.js"></script>
    <script type="text/javascript" src="gplus.js"></script>
    <link type="text/css" href="style.css" rel="stylesheet">
    <style>
    </style>
</head>
<body>
    <div id="userinfo" class="popup"></div>
    <div id="menu" class="popup"></div>
    <div id="canvas"></div>
    <script type="text/javascript">
        var params = {};
        document.location.search.replace(/^\?/, "").split("&").forEach(function(item) {
            var values = item.toLowerCase().split("=");
            var key = values[0];
            params[key] = values.length > 1 ? values[1] : "";
        })

        window.data &&
            data.links.forEach(function(d) {
                d.sourceNode = data.nodes[d.source];
                d.targetNode = data.nodes[d.target];
            });

        data = window.data || { hash : {}, nodes : [], links : [] };

        data.hash = data.hash || {};

        var w = 0,
            h = 0,
            renderTimer,
            calcTimer,
            dgraphTimer;

        var vis;

        var radiuses = function(d) {return d};
                //d3.scale.linear().range([0, 20]).domain([0, 20]);

        /*var force = pv.Force.spring(.05).damping(.1).length(20).links(data.links),
            charge = pv.Force.charge(-30).domain(2,500).theta(.8),
            drag = pv.Force.drag(.1),
            bound = pv.Constraint.bound().x(6, w - 6).y(6, h - 6),
            collision = pv.Constraint.collision(function(d) { return radiuses(d.r) * 1.2 }),
            alpha = d3.scale.ordinal().range([.08, .4]);*/

        /*var sim = pv.simulation([])
            //.force(drag)
            //.force(charge)
            //.force(force)
            //.constraint(pv.Constraint.position())
            .constraint(collision)
            //.constraint(bound)
            .stabilize()
            ;*/

        var forceGraph = d3.layout.force()
            .nodes(data.nodes)
            .links(data.links)
            //.size([w/2, h/2])
            //.friction(.9)
            .gravity(.05)
            .charge(function(d) {
                return -(d.r * 10);
            })
            //.theta(.8)
            .linkDistance(function(d) {
                return (d.target.r + d.source.r) * 1.2;
            })
            //.linkStrength(1)
            .on("tick", function(e) {
                if (window.sim)
                    sim.step();

                if (vis)
                    vis.update();
                forceGraph.start();
            });

        plusar.redrawInit(function(d) {
            forceGraph.start();
            if (vis)
                vis.render();
        });

        function startFlow() {
            w = document.body.scrollWidth,
            h = document.body.scrollHeight - 5;

            var colors = d3.scale.ordinal().range([
                d3.rgb("#29BD1C"),
                d3.rgb("#FFFE1A"),
                d3.rgb("#2C87FF"),
                d3.rgb("#FEA61D"),
                d3.rgb("#FF3F46")
            ]).domain([0, 4]);

            vis = d3.select("#canvas")
                    .append("svg:svg")
                    .style("background", "rgba(255,255,255,0.01)")
                    .attr("width", w + "px")
                    .attr("height", h + "px")
                    .append("svg:g")
                    .attr("pointer-events", "all")
                    .attr("width", w + "px")
                    .attr("height", h + "px")
                    .call(d3.behavior.zoom()
                        .translate([w/2,h/2])
                        .on("zoom", function() {
                        vis.attr("transform",
                             "translate(" + d3.event.translate + ")"
                                + "scale(" + d3.event.scale + ")");
                    }))
                    .append("svg:g")
                    .attr("transform", "scale(1)translate(" + [w/2,h/2] + ")")
                    .attr("width", w + "px")
                    .attr("height", h + "px")
                    .style("cursor", "move");

            function fill(i, d) {
                var bc = isChecked(d) ? colors(d.type) : (data.selected ? d3.rgb("#666") : colors(d.type));
                return i ? bc
                         : colors(d.type).darker().darker().darker().darker();
            }

            function fill_opacity(i, d) {
                return i ? (isChecked(d) || (d.type != 1 && plusar.gids.indexOf(d.nodeValue.id) > -1) ? .8 : alpha(d.date)) : 1;
            }

            function isChecked(d) {
                return d.clicked
                        || (
                        d.type != 1
                                && data.selected
                                && (
                                d.nodeValue.hasOwnProperty("actor")
                                        ? d.nodeValue.actor
                                        : d.nodeValue
                                ).id == data.selected
                        );
            }

            function linew(i, d) {
                var r = radiuses(d.r);
                return i
                       ? r
                       * (
                            isChecked(d)
                            ? 0.06
                            : 0.02
                         )
                       : 0;
            }

            function stroke(i, d) {
                return isChecked(d) ? "#666" : colors(d.type).darker().darker().darker().darker();
            }

            function title(d) {
                return (d.type == 1 ? d.nodeValue.title :
                    (d.nodeValue.hasOwnProperty("actor") ? d.nodeValue.actor : d.nodeValue).displayName);
            }

            function radius(i, d) {
                var r = radiuses(d.r);
                return (i ? r : r * 0.1);
            }

            vis.update = function() {
                this.selectAll(".edge path")
                    .style("stroke", function(d) { return colors(d.source.type) })
                    .style("stroke-width", function(d) { return linew(1, d.target) * 0.1; })
                    .attr("d", function(d) {
                        var xs = d.source.x,
                            ys = d.source.y,
                            xt = d.target.x,
                            yt = d.target.y;

                        var x3 = .3 * yt - .3 * ys + .8 * xs + .2 * xt;
                        var y3 = .8 * ys + .2 * yt - .3 * xt + .3 * xs;
                        var x4 = .3 * yt - .3 * ys + .2 * xs + .8 * xt;
                        var y4 = .2 * ys + .8 * yt - .3 * xt + .3 * xs;

                        return "M " + xs + "," + ys + " C " + x3 + "," + y3 + " " + x4 + "," + y4 + " " + xt + "," + yt;
                    });

                this.selectAll(".node")
                    .attr("transform", function (d) {
                        return "translate(" + [d.x , d.y] + ")";
                    })
                    .each(function(g) {
                        g = d3.select(this);
                        g.selectAll("circle").each(function(d, i) {
                            d3.select(this)
                                .attr("r", function(d) { return radius(i, d)})
                                .style("fill", function(d) { return fill(i, d) })
                                .style("fill-opacity", function(d) { return fill_opacity(i, d)})
                                .style("stroke-width", function(d) { return linew(i, d)})
                                .style("stroke", function(d) { return stroke(i, d)});
                        });
                    });
            }

            vis.renderEdge = function() {
                var edges = this.select("#edgeCont");

                if (typeof params.showedge != "undefined") {
                    if (edges.empty())
                        edges = this.append("g").attr("id", "edgeCont");

                    edges = edges.selectAll(".edge")
                        .data(data.links, function(d) {
                                return d.source.index + "_" + d.target.index;
                            })
                        ;

                    edges.enter()
                        .append("g")
                        .attr("class", "edge")
                        .append("path")
                        .style("stroke", function(d) { return colors(d.source.type) })
                        .style("stroke-width", function(d) { return linew(1, d.target); })
                        .style("fill", "none");
                }
                else
                    this.select("#edgeCont").remove();
            }

            vis.renderNode = function() {

                var nodes = this.select("#nodeCont");

                params.shownode = true;
                if (typeof params.shownode != "undefined") {
                    if (nodes.empty())
                        nodes = vis.append("g").attr("id", "nodeCont");

                    nodes = nodes.selectAll(".node")
                        .data(data.nodes.filter(function(d) {
                            return d.visible != undefined ? d.visible : true;
                        }), function(d) { return d.index })
                        ;

                    nodes.enter()
                        .append("g")
                        .attr("class", "node")
                        .on("click", function(d) {
                            d["clicked"] ? (delete d["clicked"]) : (d.clicked = 1);
                            delete data["selected"];
                            if (d["clicked"]) {
                                data.selected = (d.nodeValue.hasOwnProperty("actor")
                                    ? d.nodeValue.actor
                                    : d.nodeValue
                                ).id;
                                data.nodes.forEach(function(l) {
                                    l.index != d.index && delete l["clicked"];
                                });
                            }
                            vis.update();
                        })
                        .style("cursor", "pointer")
                        .style("opacity", ".1")
                        .call(forceGraph.drag)
                        .each(function(g) {
                            g = d3.select(this);
                            [0, 1].forEach(function(i) {
                                g.append("circle")
                                //.attr("pointer-events", "none")
                            })
                            g.append("title")
                                .text(title)
                        })
                        .transition()
                        .duration(3000)
                        .attr("transform", function (d) {
                            return "translate(" + [d.x , d.y] + ")";
                        })
                        .style("opacity", "1")
                        ;
                }
                else
                    this.select("#nodeCont").remove();
            }

            vis.render = function() {

                this.renderEdge();
                this.renderNode();
                this.update();
            }

            function firstRequest() {
                gid = (params.gids ? params.gids : null ) || data.me.id;

                plusar.Count = parseInt(params.count || plusar.Count || 10);
                plusar.Depth = parseInt(params.depth || plusar.Depth || 1);

                plusar.maxResults.replies = parseInt(params.ccount || plusar.maxResults.replies || 10);
                plusar.maxResults.plusoners = parseInt(params.ppcount || plusar.maxResults.plusoners || 10);
                plusar.maxResults.resharers = parseInt(params.rpcount || plusar.maxResults.resharers || 10);

                plusar.gids = gid.split(";");
                plusar.useRandom = plusar.Depth < 2 && plusar.gids.length < 2;
                plusar.gids.indexOf("me") > -1 && (plusar.gids[plusar.gids.indexOf("me")] = data.me.id);
                plusar.asyncForEach(plusar.gids, function(id) {
                    if (typeof data.hash[id] == "undefined") {
                        data.hash[id] = -1;
                        parseUserActivity(data, id, plusar.Count, plusar.Depth);
                    }
                });

                setTimeout(function() {
                    d3.selectAll(".trButton>span").filter(function() {
                        return !d3.select(this).classed("paused");
                    }).each(clickButton);
                }, 20000 * plusar.Depth);
            }

            var now = Date.now();

            firstRequest();
            run_renderTimer();
            run_calcTimer();
        }

        function closeInterval(timer) {
            if (timer == "dgraphTimer"){
                remakeSim();
                window[timer] = undefined;
            }
            else if (window[timer]) {
                clearInterval(window[timer]);
                window[timer] = undefined;
            }
        }

        function run_renderTimer() {
            closeInterval(renderTimer);
            renderTimer = setInterval(function() {
                //vis.render();
            }, 12);
        }

        function run_calcTimer() {
            closeInterval(calcTimer);
            calcTimer = setInterval(function() {
                //sim.step();
            }, 12);
        }

        Array.prototype.remove = function() {
            var what, a = arguments, L = a.length, ax;
            while(L && this.length){
                what = a[--L];
                while((ax = this.indexOf(what))!= -1){
                    this.splice(ax, 1);
                }
            }
            return this;
        }

        function remakeSim() {
            function collide(node) {
                var r = node.r + 20,
                        nx1 = node.x - r,
                        nx2 = node.x + r,
                        ny1 = node.y - r,
                        ny2 = node.y + r;
                return function(quad, x1, y1, x2, y2) {
                    if (quad.point && (quad.point !== node)) {
                        var x = node.x - quad.point.x,
                                y = node.y - quad.point.y,
                                l = Math.sqrt(x * x + y * y),
                                r = node.r + quad.point.r;
                        if (l < r) {
                            l = (l - r) / l * .5;
                            node.px += x * l;
                            node.py += y * l;
                        }
                    }
                    return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
                };
            }
        }

        function remakeLink(parent, old_parent, prop, delprop) {
            prop = prop || "target";
            data.links.filter(function(d) {
                return d[prop + "Index"] == old_parent.index;
            }).forEach(function(d) {
                var item = d[prop == "target" ? "source" : "target"];
                var id = (item.nodeValue.hasOwnProperty("actor") ? item.nodeValue.actor : item.nodeValue).id;
                var index = data.directHash[id];
                if (typeof index != "undefined") {
                    if(!data.directHash[index + "_" + parent.index]
                    && !data.directHash[parent.index + "_" + index]) {
                        data.directHash[index + "_" + parent.index] = data.links.length;
                        var obj = {};
                        obj[prop] = obj[prop + "Node"] = parent;
                        obj[prop + "Index"] = parent.index;
                        obj[prop == "target" ? "source" : "target"] =
                            obj[prop == "target" ? "sourceNode" : "targetNode"] = data.nodes[index];
                        obj[prop == "target" ? "sourceIndex" : "targetIndex"] = index;
                        data.links.push(obj);
                        vis.renderEdge();
                    }
                    parent = data.nodes[index];
                    incSize(parent);
                }
                decSize(d[prop]);
                d[prop] = d[prop + "Node"] = parent;
                d[prop + "Index"] = parent.index;
                incSize(parent);
            });
            deleteLinks(old_parent.index, prop == "source" ? "target" : "source");
        }

        function deleteLinks(parent, prop) {
            data.links.filter(function (d, i) {
                    return d[prop + "Index"] == parent && ((d.i = i) || true);
                })
                .map(function (d) {
                    decSize(d[prop == "source" ? "target" : "source"]);
                    return d;
                })
                .forEach(function (d) {
                    data.links.splice(d.i, 1);
                    vis.selectAll(".edge")
                        .filter(function(l) {
                            return l == d;
                        })
                        .remove();
                });
        }

        function removeNode(item) {
            item.visible = false;
            vis.selectAll(".node")
                .filter(function(d) {
                    return d.index == item.index;
                })
                .transition()
                .duration(3000)
                .attr("transform", function (m) {
                    return "translate(" + [m.x, m.y] + ")";
                })
                .style("opacity", ".1")
                .remove();
        }

        function toDirectGraph() {
            data.directHash = {};

            plusar.asyncForEach(data.nodes.slice(0)
                    .sort(function(a, b) {
                        return d3.ascending(b.linkDegree, a.linkDegree);
                    })
                    .sort(function(a, b) {
                        return d3.ascending(b.type, a.type);
            }), function(item, arr) {
                var id = (item.nodeValue.hasOwnProperty("actor") ? item.nodeValue.actor : item.nodeValue).id;
                var index = data.directHash[id];
                if (typeof index == "undefined") {
                    index = item.index;
                    data.directHash[id] = index;
                    item.linkDegree = -1;
                    item.r = 6;
                }
                var parent = data.nodes[index];
                incSize(parent);

                if (item.type == 1) {
                    /*item.r = 4;
                    item.linkDegree = 0;*/

                    remakeLink(parent, item);
                    removeNode(item);
                } else if (parent.index != item.index) {
                    item.r = 4;
                    item.linkDegree = 0;

                    remakeLink(parent, item);
                    removeNode(item);
                }
            });

        }

        function run_dgraphTimer() {
            closeInterval(dgraphTimer);
            dgraphTimer = 1;
            toDirectGraph();
        }

        function handleClientLoad() {
            gapi.client.setApiKey(conf.API_KEY);
            window.setTimeout(function() {
                (plusar.useKey && makeApiCall()) || checkAuth(makeApiCall);
            }, 1);
        }

        function clickButton(d) {
            if (window[d + "Timer"]) {
                closeInterval(d + "Timer");
                d3.select(this).classed("paused", true)
                        .text("►");
            }
            else {
                if (window["run_" + d + "Timer"]) {
                    window["run_" + d + "Timer"]();
                    d3.select(this).classed("paused", false)
                        .text("■");
                }
            }
        }

        // Load the API and make an API call.  Display the results on the screen.
        function makeApiCall() {
            gapi.client.load('plus', 'v1', function() {
                var request = gapi.client.plus.people.get({
                    'userId': 'me'
                });
                request.execute(function(resp) {
                    data.me = resp;

                    d3.select("#userinfo")
                        .call(function(div) {
                            div.append("img")
                                .attr("src", resp.image.url);
                            div.append("ul")
                                .call(function(ul) {
                                    ul.append("li")
                                        .append("span")
                                        .append("a")
                                        .attr("href", resp.url)
                                        .attr("target", "blank")
                                        .text(resp.displayName);
                                    ul.append("li").append("a")
                                        .attr("href", "javascript: void(0)")
                                        .text("logout");
                                })
                        });

                    d3.select("#menu")
                        .call(function(div) {
                            div.selectAll(".trButton")
                                .data(["calc", "render", "dgraph"])
                                .enter()
                                .append("span")
                                    .attr("class", "trButton")
                                    .text(String)
                                    .append("span")
                                    .attr("class", function(d) { return d == "dgraph" ? "paused" : ""})
                                    .text(function(d) { return d3.select(this).classed("paused") ? "►" : "■"; })
                                    .attr("id", function(d) {
                                        return d + "Timer";
                                    })
                                    .on("click", clickButton);
                        });
                    startFlow();
                });
            });
        }
    </script>
    <script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
  </body>
</html>