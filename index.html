<!--
  Copyright (c) 2012 Artem Zubkov.

  Licensed under the Apache License, Version 2.0 (the "License"); you may not
  use this file except in compliance with the License. You may obtain a copy of
  the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
  License for the specific language governing permissions and limitations under
  the License.
-->
<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'/>
    <title>Google Plus Users Visualization</title>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta content="Artem Zubkov" name="Author">
    <meta content="data visualization, datavis, infovis, javascript, complexity, math, generative, art, media, design, programming, experimental, computer, network, graph, interaction, interface, information, science, infographics, google plus" name="Keywords">
    <meta content="Visualization relationship the users on Google Plus" name="Description">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" name="viewport">
    <meta content="og.png" property="og:image">

    <script type="text/javascript" src="d3.v2.js"></script>
    <!--script type="text/javascript" src="protovis.js"></script-->
    <script type="text/javascript" src="global.js"></script>
    <script type="text/javascript" src="plusart.js"></script>
    <script type="text/javascript" src="conf.js"></script>
    <script type="text/javascript" src="storage.js"></script>
    <script type="text/javascript" src="oauth.js"></script>
    <script type="text/javascript" src="gplus.js"></script>
    <link type="text/css" href="style.css" rel="stylesheet">
</head>
<body>
    <div id="userinfo" class="popup"></div>
    <div id="menu" class="popup"></div>
    <div id="canvas"></div>
    <script type="text/javascript">
        //"use strict";
        var params = {};
        document.location.search.replace(/^\?/, "").split("&").forEach(function(item) {
            var values = item.toLowerCase().split("=");
            var key = values[0];
            params[key] = values.length > 1 ? values[1] : "";
        });

        window.data &&
            data.links.forEach(function(d) {
                d.sourceNode = data.nodes[d.source];
                d.targetNode = data.nodes[d.target];
            });

        window.data = window.data || {
            hash : {},
            nodes : [],
            links : []
        };

        data.getIdByIndex = function(i) {
            var d;
            return i > -1 && data.nodes.length > i && (d = this.nodes[i]) ? (d.nodeValue.hasOwnProperty("actor")
                ? d.nodeValue.actor
                : d.nodeValue
            ).id : null;
        };

        data.getSelected = function() {
            return data.selected > -1 && data.nodes.length > data.selected
                ? data.nodes[data.selected]
                : null;
        };

        data.hash = data.hash || {};

        var w = 0,
            h = 0,
            renderTimer,
            calcTimer,
            dgraphTimer;

        var vis;
        var alpha = d3.scale.ordinal();

        function callAlpha(d) {
            if (d) {
                var arr = alpha.domain().concat(
                        [d.date = (d.type == 0 && d.dates.length && d3.max(d.dates)) || d.date]);
                var i = .5 / (arr.length || 1); //1;
                alpha.range(d3.range(.1, .5, i));
                alpha.domain(
                    arr.sort(d3.ascending)
                );
            }
        }

        var radiuses = function(d) {return d};

        var forceGraph = d3.layout.force()
            .nodes(data.nodes)
            .links(data.links)
            //.size([w, h])
            .friction(.9)
            .gravity(.05)
            .charge(function(d) {
                return -(d.r * 10);
            })
            .theta(.8)
            .linkDistance(function(d) {
                return (d.target.r + d.source.r) * 1.2;
            })
            .linkStrength(1.2)
            .on("tick", function(e) {
                if (vis)
                    vis.update();
                /*if (calcTimer)
                    forceGraph.alpha(.01);*/
            })
            .on("end", function() {
                calcTimer = true;
                d3.select("span#calcTimer").each(clickButton);
            })
            .on("start", function() {
                calcTimer = undefined;
                d3.select("span#calcTimer").each(clickButton);
            })
            ;
        forceGraph.restart = function() {
            this.resume();
            calcTimer = undefined;
            d3.select("span#calcTimer").each(clickButton);
        };

        plusart.redrawInit(function(d) {
            forceGraph.start();
            if (d)
                callAlpha(d);
            /*if (vis)
                vis.render();*/
        });

        function resize() {
            w = d3.max([
                    //document.body.scrollWidth,
                    //document.body.offsetWidth,
                    document.body.clientWidth,
                    window.innerWidth
                    //document.documentElement.clientWidth,
                    //document.documentElement.scrollWidth,
                    //document.documentElement.offsetWidth
            ]);
            h = d3.max([
                    //document.body.scrollHeight,
                    //document.body.offsetHeight,
                    document.body.clientHeight,
                    window.innerHeight
                    //document.documentElement.clientHeight,
                    //document.documentElement.scrollHeight,
                    //document.documentElement.offsetHeight
            ]) - 5;

            //forceGraph && forceGraph.size([w, h]);
        }

        function startFlow() {
            resize();

            var colors = d3.scale.ordinal().range([
                d3.rgb("#29BD1C"),
                d3.rgb("#FFFE1A"),
                d3.rgb("#2C87FF"),
                d3.rgb("#FEA61D"),
                d3.rgb("#FF3F46")
            ]).domain([0, 4]);

            vis = {
                transform : {
                    translate : [w/2, h/2],
                    scale : 1
                },
                checkVisible : function (d) {
                    resize();
                    var tf = this.transform,
                        tx = tf.translate[0]/tf.scale,
                        ty = tf.translate[1]/tf.scale
                        ;
                    d.visible = d.visible != undefined ? d.visible : true;

                    return d.visible && (
                            d.x + d.r > -tx
                         && d.x - d.r < -tx + w/tf.scale
                         && d.y + d.r > -ty
                         && d.y - d.r < -ty + h/tf.scale
                    );
                },
                renderEdge : function() {
                    if (typeof params.showedge != "undefined") {
                        var context = this.canvas;

                        if (!context)
                            return;

                        //plusart.asyncForEach(
                                forceGraph.links().forEach(function (d) {

                            var c = fill(1, d.source);
                            context.strokeStyle = "rgba(" + [c.r, c.g, c.b, fill_opacity(1, d.source)] + ")";

                            //context.strokeStyle = colors(d.source.type).toString();
                            context.lineWidth = 1;//linew(1, d.target);

                            var xs = d.source.x,
                                ys = d.source.y,
                                xt = d.target.x,
                                yt = d.target.y;

                            if (vis.checkVisible(d.source) || vis.checkVisible(d.target)) {
                                context.beginPath();
                                context.moveTo(xs, ys);
                                var x3 = .3 * yt - .3 * ys + .8 * xs + .2 * xt,
                                    y3 = .8 * ys + .2 * yt - .3 * xt + .3 * xs,
                                    x4 = .3 * yt - .3 * ys + .2 * xs + .8 * xt,
                                    y4 = .2 * ys + .8 * yt - .3 * xt + .3 * xs;
                                context.bezierCurveTo(x3, y3, x4, y4, xt, yt);
                                context.stroke();
                            }
                        });
                    }
                },
                renderNode : function() {
                    params.shownode = true;
                    if (typeof params.shownode != "undefined") {
                        var context = this.canvas;

                        if (!context)
                            return;

                        var nodes = forceGraph.nodes(),
                            i = nodes.length,
                            d;

                        while(--i > -1) {
                            d = nodes[i];
                            if (vis.checkVisible(d)) {
                                for(var ind = 1; ind > -1; --ind) {
                                    context.beginPath();
                                    var c = fill(ind, d);
                                    context.fillStyle = "rgba(" + [c.r, c.g, c.b, fill_opacity(ind, d)] + ")";
                                    context.strokeStyle = ind ? stroke(ind, d).toString() : "none";
                                    context.lineWidth = linew(ind, d);
                                    context.arc(d.x, d.y, radius(ind, d), 0, Math.PI * 2, true);
                                    context.fill();
                                    context.stroke();
                                }
                            }
                        }
                    }
                },
                update : function() {
                    //vis.zoom();
                    vis.valide = false;
                },
                render : function() {
                    this.renderEdge();
                    this.renderNode();
                },
                zoom : function() {
                    if (this.canvas) {
                        this.canvas.clearRect(0, 0, w, h);

                        this.canvas.save();

                        if (vis.event && !vis.dragOn) {
                            if (vis.event.hasOwnProperty("translate"))
                                this.transform.translate = vis.event.translate.slice(0);
                            if (vis.event.hasOwnProperty("scale"))
                                this.transform.scale = vis.event.scale;
                            vis.event = undefined;
                        }

                        this.canvas.translate(this.transform.translate[0], this.transform.translate[1]);
                        this.canvas.scale(this.transform.scale, this.transform.scale);

                        this.render();
                        this.canvas.restore();
                    }
                },
                contain : function(d, pos) {
                    var px = (this.transform.translate[0] - pos[0]) / this.transform.scale,
                        py = (this.transform.translate[1] - pos[1]) / this.transform.scale,
                        r = Math.sqrt( Math.pow( d.x + px , 2) +
                                Math.pow( d.y + py , 2 ) );

                    return r < d.r;
                },
                getNodeFromPos : function(pos) {
                    for (var i = data.nodes.length - 1; i >= 0; i--) {
                        var d = data.nodes[i];
                        if (d.visible && this.contain(d, pos))
                            return d;
                    }
                    return null;
                }
            };

            function zoom() {
                if (!vis.dragOn
                    && d3.event
                    && d3.event.type
                    && d3.event.type == "zoom")
                    vis.event = d3.event;
                forceGraph.restart();
            }

            var zoomBehavior = d3.behavior.zoom()
                .translate(vis.transform.translate)
                .scale(vis.transform.scale)
                .scaleExtent([.001, 100])
                .on("zoom", zoom);

            function resizeWindow(event) {
                return function() {
                    resize();

                    d3.select(vis.canvas.canvas)
                        .attr("width", w)
                        .attr("height", h);

                    vis.canvas.canvas.width = w;
                    vis.canvas.canvas.height = h;

                    zoom();
                }
            }

            var resizeTimer;
            d3.select(window).on("onresize", function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(resizeWindow(d3.event), 100);
            });

            vis.canvas = d3.select("body")
                    .append("canvas")
                    .text("Your browser does not have support for Canvas.")
                    .call(zoomBehavior)
                    .on("mousedown.canvas", function(d) {
                        (d = data.getSelected())
                        && (vis.dragOn = true)
                        && (d3.select("body").style("cursor", "move"))
                        && (d.fixed |= 2);
                    })
                    .on("mouseup.canvas", function(d) {
                        vis.dragOn = false;
                        (d = data.getSelected())
                        && (zoomBehavior.translate(vis.transform.translate)
                            .scale(vis.transform.scale))
                        && (d.fixed &= 1);
                    })
                    .on("mousemove.canvas", function(d) {
                        if (!vis.dragOn) {
                            d = null;
                            if (data.hasOwnProperty("selected")) {
                                var od = data.getSelected();
                                if (vis.contain(od, d3.mouse(this)))
                                    d = od;
                                if (!d) {
                                    od && (od.fixed &= 3);
                                    delete data["selected"];
                                    d3.select("body").style("cursor", "default");
                                }
                            }
                            else
                                d = vis.getNodeFromPos(d3.mouse(this));

                            if (d) {
                                data.selected = d.index;
                                d.fixed |= 4;
                                d3.select("body").style("cursor", "pointer");
                                forceGraph.restart();
                            }
                        }
                        else {
                            d = data.getSelected();
                            if (d) {
                                d.px = (d3.event.pageX - vis.transform.translate[0]) / vis.transform.scale;
                                d.py = (d3.event.pageY - vis.transform.translate[1]) / vis.transform.scale;
                                forceGraph.restart();
                            }
                        }
                    })
                    .node().getContext("2d");

            resizeWindow()();

            function fill(i, d) {
                var bc = isChecked(d) ? colors(d.type) : (data.selected > -1 ? d3.rgb("#666") : colors(d.type));
                return i ? bc
                         : colors(d.type)/*.darker().darker()*/.darker().darker();
            }

            function fill_opacity(i, d) {
                return i ? (isChecked(d) || (d.type != 1 && plusart.gids.indexOf(d.nodeValue.id) > -1) ? .8 : alpha(d.date)) : 1;
            }

            function isChecked(d) {
                return d.clicked
                        || d.index == data.selected
                        || (
                        d.type != 1
                                && data.selected > -1
                                && (
                                d.nodeValue.hasOwnProperty("actor")
                                        ? d.nodeValue.actor
                                        : d.nodeValue
                                ).id == data.getIdByIndex(data.selected)
                        );
            }

            function linew(i, d) {
                var r = radiuses(d.r);
                return i
                       ? r
                       * (
                            isChecked(d)
                            ? 0.06
                            : 0.02
                         )
                       : 0;
            }

            function stroke(i, d) {
                return isChecked(d) ? colors(d.type)/*.darker().darker()*/.darker().darker() : "#666";
            }

            function title(d) {
                return (d.type == 1 ? d.nodeValue.title :
                    (d.nodeValue.hasOwnProperty("actor") ? d.nodeValue.actor : d.nodeValue).displayName);
            }

            function radius(i, d) {
                var r = radiuses(d.r);
                return (i ? r : r * 0.1);
            }

            function firstRequest() {
                var gid = (params.gids ? params.gids : null ) || data.me.id;

                plusart.Count = parseInt(params.count || plusart.Count || 10);
                plusart.Depth = parseInt(params.depth || plusart.Depth || 1);

                plusart.maxResults.replies = parseInt(params.ccount || plusart.maxResults.replies || 10);
                plusart.maxResults.plusoners = parseInt(params.ppcount || plusart.maxResults.plusoners || 10);
                plusart.maxResults.resharers = parseInt(params.rpcount || plusart.maxResults.resharers || 10);

                plusart.gids = gid.split(";");
                plusart.useRandom = plusart.Depth < 2 && plusart.gids.length < 2;
                plusart.gids.indexOf("me") > -1 && (plusart.gids[plusart.gids.indexOf("me")] = data.me.id);
                plusart.asyncForEach(plusart.gids, function(id) {
                    if (typeof data.hash[id] == "undefined") {
                        data.hash[id] = -1;
                        parseUserActivity(data, id, plusart.Count, plusart.Depth);
                    }
                });
            }

            var now = Date.now();

            firstRequest();
            run_renderTimer();
            run_calcTimer();
        }

        function closeInterval(timer) {
            if (timer == "dgraphTimer"){
                remakeSim();
                window[timer] = undefined;
            }
            else if (timer == "renderTimer") {
                clearTimeout(window[timer]);
                window[timer] = undefined;
            }
            else if (window[timer]) {
                clearInterval(window[timer]);
                window[timer] = undefined;
            }
        }

        function run_renderTimer() {
            closeInterval("renderTimer");
            renderTimer = true;
            (function animloop(time){
                if (renderTimer)
                    requestAnimationFrame(animloop);
                if (!vis.valide) {
                    vis.zoom();
                    vis.valide = true;
                }
            })();
        }

        function run_calcTimer() {
            closeInterval("calcTimer");
            calcTimer = true;
            forceGraph.start();
        }

        function remakeSim() {

        }

        function remakeLink(parent, old_parent, prop) {
            prop = prop || "target";
            forceGraph.links().filter(function(d) {
                return d[prop + "Index"] == old_parent.index;
            }).forEach(function(d) {
                var item = d[prop == "target" ? "source" : "target"];
                var id = (item.nodeValue.hasOwnProperty("actor") ? item.nodeValue.actor : item.nodeValue).id;
                var index = data.directHash[id];
                if (typeof index != "undefined") {
                    if(!data.directHash[index + "_" + parent.index]
                    && !data.directHash[parent.index + "_" + index]) {
                        data.directHash[index + "_" + parent.index] = data.links.length;
                        var obj = {};
                        obj[prop] = obj[prop + "Node"] = parent;
                        obj[prop + "Index"] = parent.index;
                        obj[prop == "target" ? "source" : "target"] =
                            obj[prop == "target" ? "sourceNode" : "targetNode"] = data.nodes[index];
                        obj[prop == "target" ? "sourceIndex" : "targetIndex"] = index;
                        forceGraph.links().push(obj);
                        vis.renderEdge();
                    }
                    parent = data.nodes[index];
                    incSize(parent);
                }
                decSize(d[prop]);
                d[prop] = d[prop + "Node"] = parent;
                d[prop + "Index"] = parent.index;
                incSize(parent);
            });
            deleteLinks(old_parent.index, prop == "source" ? "target" : "source");
        }

        function deleteLinks(parent, prop) {
            forceGraph.links().filter(function (d, i) {
                    return d[prop + "Index"] == parent && ((d.i = i) || true);
                })
                .map(function (d) {
                    decSize(d[prop == "source" ? "target" : "source"]);
                    return d;
                })
                .forEach(function (d) {
                    forceGraph.stop();
                    forceGraph.links().splice(d.i, 1);
                    forceGraph.start();
                });
        }

        function removeNode(item) {
            item.visible = false;
        }

        function toDirectGraph() {
            data.directHash = {};

            plusart.asyncForEach(data.nodes.slice(0)
                    .sort(function(a, b) {
                        return d3.ascending(a.date, b.date);
                    })
                    .sort(function(a, b) {
                        return d3.ascending(b.type, a.type);
            }), function(item, arr) {
                var id = (item.nodeValue.hasOwnProperty("actor") ? item.nodeValue.actor : item.nodeValue).id;
                var index = data.directHash[id];
                if (typeof index == "undefined") {
                    index = item.index;
                    data.directHash[id] = index;
                    item.linkDegree = -1;
                    item.r = 6;
                }
                var parent = data.nodes[index];
                incSize(parent);

                if (item.type == 1) {
                    remakeLink(parent, item);
                    removeNode(item);
                } else if (parent.index != item.index) {
                    item.r = 4;
                    item.linkDegree = 0;

                    remakeLink(parent, item);
                    removeNode(item);
                }
            });

        }

        function run_dgraphTimer() {
            closeInterval(dgraphTimer);
            dgraphTimer = true;
            toDirectGraph();
        }

        function handleClientLoad() {
            gapi.client.setApiKey(conf.API_KEY);
            window.setTimeout(function() {
                (plusart.useKey && makeApiCall()) || checkAuth(makeApiCall);
            }, 1);
        }

        function clickButton(d) {
            if (window[d + "Timer"]) {
                closeInterval(d + "Timer");
                d3.select(this).classed("paused", true)
                        .text("►");
            }
            else {
                if (window["run_" + d + "Timer"]) {
                    window["run_" + d + "Timer"]();
                    d3.select(this).classed("paused", false)
                        .text("■");
                }
            }
        }

        // Load the API and make an API call.  Display the results on the screen.
        function makeApiCall() {
            gapi.client.load('plus', 'v1', function() {
                var request = gapi.client.plus.people.get({
                    'userId': 'me'
                });
                request.execute(function(resp) {
                    data.me = resp;

                    d3.select("#userinfo")
                        .call(function(div) {
                            div.append("img")
                                .attr("src", resp.image.url);
                            div.append("ul")
                                .call(function(ul) {
                                    ul.append("li")
                                        .append("span")
                                        .append("a")
                                        .attr("href", resp.url)
                                        .attr("target", "blank")
                                        .text(resp.displayName);
                                    ul.append("li").append("a")
                                        .attr("href", "javascript: void(0)")
                                        .text("logout");
                                })
                        });

                    d3.select("#menu")
                        .call(function(div) {
                            div.selectAll(".trButton")
                                .data(["calc", "render", "dgraph"])
                                .enter()
                                .append("span")
                                    .attr("class", "trButton")
                                    .text(String)
                                    .append("span")
                                    .attr("class", function(d) { return d == "dgraph" ? "paused" : ""})
                                    .text(function(d) { return d3.select(this).classed("paused") ? "►" : "■"; })
                                    .attr("id", function(d) {
                                        return d + "Timer";
                                    })
                                    .on("click", clickButton);
                        });
                    startFlow();
                });
            });
        }
    </script>
    <script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
  </body>
</html>