<!--
  Copyright (c) 2011 Google Inc.

  Licensed under the Apache License, Version 2.0 (the "License"); you may not
  use this file except in compliance with the License. You may obtain a copy of
  the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
  License for the specific language governing permissions and limitations under
  the License.

  To run this sample, replace YOUR API KEY with your application's API key.
  It can be found at https://code.google.com/apis/console/?api=plus under API Access.
  Activate the Google+ service at https://code.google.com/apis/console/ under Services
-->
<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'/>
    <script type="text/javascript" src="d3.v2.js"></script>
    <script type="text/javascript" src="protovis.js"></script>
    <script type="text/javascript" src="global.js"></script>
    <script type="text/javascript" src="conf.js"></script>
    <script type="text/javascript" src="storage.js"></script>
    <script type="text/javascript" src="oauth.js"></script>
    <script type="text/javascript" src="gplus.js"></script>
    <link type="text/css" href="style.css" rel="stylesheet">
    <style>
    </style>
</head>
<body>
    <div id="userinfo" class="popup"></div>
    <div id="menu" class="popup"></div>
    <script type="text/javascript">
        var params = {};
        document.location.search.replace(/^\?/, "").split("&").forEach(function(item) {
            var values = item.toLowerCase().split("=");
            var key = values[0];
            params[key] = values.length > 1 ? values[1] : "";
        })

        window.data &&
            data.links.forEach(function(d) {
                d.sourceNode = data.nodes[d.source];
                d.targetNode = data.nodes[d.target];
            });

        data = window.data || { hash : {}, nodes : [], links : [] };

        data.hash = data.hash || {};

        var w = 0,
            h = 0,
            renderTimer,
            calcTimer,
            dgraphTimer;

        var vis;

        var force = pv.Force.spring().links(data.links),
            alpha = pv.Scale.linear().range(.05, .4);

        var sim = pv.simulation(data.nodes)
            .constraint(pv.Constraint.collision(function(d) { return d.r * 1.2 } ))
            .force(pv.Force.drag(.07))
            .force(force)
            .force(pv.Force.charge())
            .stabilize();

        function startFlow() {
            w = document.body.scrollWidth,
            h = document.body.scrollHeight - 5;

            var colors = pv.colors(
                "#29BD1C",
                "#FFFE1A",
                "#2C87FF",
                "#FEA61D",
                "#FF3F46"
            ).domain(0, 4);

            vis = new pv.Panel()
                    .cursor("move")
                    .width(w)
                    .height(h)
                    .fillStyle("rgba(255,255,255,0.01)")//"#f9f9f9")
                    .event("mousedown", pv.Behavior.pan())
                    .event("mousewheel", pv.Behavior.zoom(1/12));

            if (typeof params.showedge != "undefined")
                vis.add(pv.Panel)
                    .data(data.links)
                  .add(pv.Line)
                    .data(function(d) {return [d.sourceNode, d.targetNode]; })
                    .left(function(d) { return d.x; })
                    .top(function(d) { return d.y; })
                    .strokeStyle("rgba(0, 0, 0, .1)");

            function fill(i, d) {
                var a = d.type != 1 && plusar.gids.indexOf(d.nodeValue.id) > -1 ? .8 : alpha(d.date),
                    bc = isChecked(d) ? colors(d.type).alpha(.8) : (data.selected ? pv.color("#666") : colors(d.type)).alpha(a);
                return i ? bc
                         : colors(d.type).darker().darker().darker().darker();
            }

            function isChecked(d) {
                return d.clicked
                        || (
                        d.type != 1
                                && data.selected
                                && (
                                d.nodeValue.hasOwnProperty("actor")
                                        ? d.nodeValue.actor
                                        : d.nodeValue
                                ).id == data.selected
                        );
            }

            function linew(i, d) {
                return i
                       ? d.r
                       * (
                            isChecked(d)
                            ? 0.06
                            : 0.02
                         )
                       : 0;
            }

            function stroke(i, d) {
                return isChecked(d) ? "#666" : this.fillStyle().alpha(1).darker().darker().darker().darker();
            }

            vis.add(pv.Panel)
                .data(data.nodes)
                .event("click", function(d) {
                    d["clicked"] ? (delete d["clicked"]) : (d.clicked = 1);
                    delete data["selected"];
                    if (d["clicked"]) {
                        data.selected = (d.nodeValue.hasOwnProperty("actor")
                            ? d.nodeValue.actor
                            : d.nodeValue
                        ).id;
                        data.nodes.forEach(function(l) {
                            l.index != d.index && delete l["clicked"];
                        });
                    }
                    vis.render();
                })
                .event("mousedown", pv.Behavior.drag())
            .add(pv.Dot)
                .data(pv.range(2))
                .cursor("pointer")
                .left(function(i, d) { return d.x })
                .top(function(i, d) { return d.y })
                .title(function(i, d) {return i ?
                    (d.type == 1 ? d.nodeValue.title :
                    (d.nodeValue.hasOwnProperty("actor") ? d.nodeValue.actor : d.nodeValue).displayName) : alpha(d.date); })
                .radius(function(i, d) { return i ? d.r : d.r * 0.05; })
                .lineWidth(linew)
                .fillStyle(fill)
                .strokeStyle(stroke);

            /*vis.add(pv.Panel)
                .data(data.nodes)
              .add(pv.Line)
                .data(pv.range(2))
                .strokeStyle(pv.ramp("steelblue", "brown", "steelblue").by(function(i, d) { return d.vx * d.vx + d.vy * d.vy }))
                .left(function(i, d) { return d.x + i * 10 * d.vx })
                .top(function(i, d) { return d.y + i * 10 * d.vy });*/

            function firstRequest() {
                gid = (params.gids ? params.gids : null ) || data.me.id;

                plusar.Count = parseInt(params.count || plusar.Count || 10);
                plusar.Depth = parseInt(params.depth || plusar.Depth || 1);

                plusar.maxResults.replies = parseInt(params.ccount || plusar.maxResults.replies || 10);
                plusar.maxResults.plusoners = parseInt(params.ppcount || plusar.maxResults.plusoners || 10);
                plusar.maxResults.resharers = parseInt(params.rpcount || plusar.maxResults.resharers || 10);

                plusar.gids = gid.split(";");
                plusar.useRandom = plusar.Depth < 2 || plusar.gids.length > 1;
                plusar.gids.indexOf("me") > -1 && (plusar.gids[plusar.gids.indexOf("me")] = data.me.id);
                plusar.asyncForEach(plusar.gids, function(id) {
                    parseUserActivity(data, id, plusar.Count, plusar.Depth);
                });

                setTimeout(function() {
                    d3.selectAll(".trButton>span").filter(function() {
                        return !d3.select(this).classed("paused");
                    }).each(clickButton);
                }, 20000 * plusar.Depth);
            }

            var now = Date.now();

            firstRequest();
            run_renderTimer();
            run_calcTimer();
        }

        function closeInterval(timer) {
            if (timer == "dgraphTimer"){
                remakeSim();
                window[timer] = undefined;
            }
            else if (window[timer]) {
                clearInterval(window[timer]);
                window[timer] = undefined;
            }
        }

        function run_renderTimer() {
            closeInterval(renderTimer);
            renderTimer = setInterval(function() {
                vis.render();
            }, 12);
        }

        function run_calcTimer() {
            closeInterval(calcTimer);
            calcTimer = setInterval(function() {
                sim.step();
            }, 12);
        }

        Array.prototype.remove = function() {
            var what, a = arguments, L = a.length, ax;
            while(L && this.length){
                what = a[--L];
                while((ax = this.indexOf(what))!= -1){
                    this.splice(ax, 1);
                }
            }
            return this;
        }

        function remakeLink(parent, old_parent, prop, delprop) {
            prop = prop || "target";
            data.links.filter(function(d) {
                return d[prop] == old_parent;
            }).forEach(function(d) {
                var item = d[prop == "target" ? "sourceNode" : "targetNode"];
                var id = (item.nodeValue.hasOwnProperty("actor") ? item.nodeValue.actor : item.nodeValue).id;
                var index = data.directHash[id];
                if (typeof index != "undefined") {
                    if(!data.directHash[index + "_" + parent.index]
                    && !data.directHash[parent.index + "_" + index]) {
                        data.directHash[index + "_" + parent.index] = data.links.length;
                        var obj = {};
                        obj[prop] = parent.index;
                        obj[prop + "Node"] = parent;
                        obj[prop == "target" ? "source" : "target"] = index;
                        obj[prop == "target" ? "sourceNode" : "targetNode"] = data.nodes[index];
                        data.links.push(obj);
                    }
                    parent = data.nodes[index];
                    incSize(parent);
                }
                decSize(d[prop + "Node"]);
                d[prop] = parent.index;
                d[prop + "Node"] = parent;
                incSize(parent);
            });
            deleteLinks(old_parent, prop == "source" ? "targetNode" : "sourceNode");
            force.links(data.links);
        }

        function remakeSim() {
        }

        function deleteLinks(parent, prop) {
            data.links.filter(function (d, i) {
                    return d.source == parent && ((d.i = i) || true);
                })
                .map(function (d) {
                    decSize(d.targetNode);
                    return d.i;
                })
                .forEach(function (d) {
                    data.links.splice(d, 1);
                });
        }

        function toDirectGraph() {
            data.directHash = {};

            plusar.asyncForEach(data.nodes.slice(0)
                    .sort(function(a, b) {
                        return d3.ascending(b.linkDegree, a.linkDegree);
                    })
                    .sort(function(a, b) {
                        return d3.ascending(b.date, a.date);
                    })
                    .sort(function(a, b) {
                        return d3.ascending(b.type, a.type);
            }), function(item) {
                var id = (item.nodeValue.hasOwnProperty("actor") ? item.nodeValue.actor : item.nodeValue).id;
                var index = data.directHash[id];
                if (typeof index == "undefined") {
                    index = item.index;
                    data.directHash[id] = index;
                    item.linkDegree = -1;
                    item.r = 6;
                }
                var parent = data.nodes[index];
                incSize(parent);

                if (item.type == 1) {
                    /*item.r = 4;
                    item.linkDegree = 0;*/

                    remakeLink(parent, item.index);
                } else if (parent.index != item.index) {
                    item.r = 4;
                    item.linkDegree = 0;

                    remakeLink(parent, item.index);

                    /*deleteLinks(item.index);

                    data.links.push({
                        source: item.index,
                        sourceNode: item,
                        target: parent.index,
                        targetNode: parent
                    });
                    force.links(data.links);*/
                }
            });
        }

        function run_dgraphTimer() {
            //closeInterval(dgraphTimer);
            dgraphTimer = 1;
            toDirectGraph();
        }

        function handleClientLoad() {
            gapi.client.setApiKey(conf.API_KEY);
            window.setTimeout(function() {
                (plusar.useKey && makeApiCall()) || checkAuth(makeApiCall);
            }, 1);
        }

        function clickButton(d) {
            if (window[d + "Timer"]) {
                closeInterval(d + "Timer");
                d3.select(this).classed("paused", true)
                        .text("►");
            }
            else {
                if (window["run_" + d + "Timer"]) {
                    window["run_" + d + "Timer"]();
                    d3.select(this).classed("paused", false)
                        .text("■");
                }
            }
        }

        // Load the API and make an API call.  Display the results on the screen.
        function makeApiCall() {
            gapi.client.load('plus', 'v1', function() {
                var request = gapi.client.plus.people.get({
                    'userId': 'me'
                });
                request.execute(function(resp) {
                    data.me = resp;

                    d3.select("#userinfo")
                        .call(function(div) {
                            div.append("img")
                                .attr("src", resp.image.url);
                            div.append("ul")
                                .call(function(ul) {
                                    ul.append("li").append("span")
                                        .text(resp.displayName);
                                    ul.append("li").append("a")
                                        .attr("href", "javascript: void(0)")
                                        .text("logout");
                                })
                        });

                    d3.select("#menu")
                        .call(function(div) {
                            div.selectAll(".trButton")
                                .data(["calc", "render", "dgraph"])
                                .enter()
                                .append("span")
                                    .attr("class", "trButton")
                                    .text(String)
                                    .append("span")
                                    .attr("class", function(d) { return d == "dgraph" ? "paused" : ""})
                                    .text(function(d) { return d3.select(this).classed("paused") ? "►" : "■"; })
                                    .attr("id", function(d) {
                                        return d + "Timer";
                                    })
                                    .on("click", clickButton);
                        });
                    startFlow();
                });
            });
        }
    </script>
    <script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
  </body>
</html>